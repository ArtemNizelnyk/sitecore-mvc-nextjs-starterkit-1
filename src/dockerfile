FROM node:12
COPY package*.json /home/
COPY .npmrc /home/.npmrc
WORKDIR /home

ARG NPM_TOKEN
ENV NPM_TOKEN="${NPM_TOKEN}"

RUN npm install

ENV NPM_TOKEN=""

COPY . /home

ARG PORT=3000
ENV PORT="${PORT}"

ARG AZURE_STORAGE_ACCOUNT
ENV AZURE_STORAGE_ACCOUNT="${AZURE_STORAGE_ACCOUNT}"

ARG AZURE_STORAGE_ACCESS_KEY
ENV AZURE_STORAGE_ACCESS_KEY="${AZURE_STORAGE_ACCESS_KEY}"

ARG UNIFORM_DATA_URL
ENV UNIFORM_DATA_URL="${UNIFORM_DATA_URL}"

ARG UNIFORM_API_URL
ENV UNIFORM_API_URL="${UNIFORM_API_URL}"

ARG UNIFORM_API_TOKEN
ENV UNIFORM_API_TOKEN="${UNIFORM_API_TOKEN}"

ARG UNIFORM_PUBLISH_AZUREBLOB_PUBLIC_URL
ENV UNIFORM_PUBLISH_AZUREBLOB_PUBLIC_URL="${UNIFORM_PUBLISH_AZUREBLOB_PUBLIC_URL}"

RUN npm run build > build.log
RUN base64 -w 0 build.log

ARG TIMBER_KEY
ENV TIMBER_KEY="${TIMBER_KEY}"

ARG TIMBER_ID
ENV TIMBER_ID="${TIMBER_ID}"

ENV NODE_ENV=production

EXPOSE ${PORT}

CMD [ "node", "server.js" ]
